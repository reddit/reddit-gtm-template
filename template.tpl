___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "displayName": "Reddit Pixel",
  "description": "By using the Reddit Conversion Pixel you agree to comply with and to be bound by the Reddit Advertiser Measurement Program Terms\n\nhttps://www.reddithelp.com/en/categories/advertising/policy-guideline",
  "securityGroups": [],
  "id": "cvt_PBGZL",
  "type": "TAG",
  "version": 1,
  "brand": {
    "thumbnail": "data:image/png;base64,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\u003d",
    "displayName": "reddit",
    "id": "github.com_reddit"
  },
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "help": "You can find your pixel ID at \u003ca href\u003d\"https://ads.reddit.com/events-manager#pixel-onboarding/gtm\"\u003ehttps://ads.reddit.com/events-manager#pixel-onboarding/gtm\u003c/a\u003e",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "args": [
          3,
          100
        ],
        "type": "STRING_LENGTH"
      },
      {
        "args": [
          "(t2_|a2_)[a-z0-9]+"
        ],
        "type": "REGEX"
      }
    ],
    "displayName": "Pixel ID",
    "simpleValueType": true,
    "name": "id",
    "type": "TEXT",
    "valueHint": "t2_***** or a2_*****"
  },
  {
    "type": "TEXT",
    "name": "partner",
    "simpleValueType": true,
    "displayName": "Integration",
    "help": "This value is created and set by the automatic installation flow"
  },
  {
    "macrosInSelect": true,
    "selectItems": [
      {
        "displayValue": "Page Visit",
        "value": "PageVisit"
      },
      {
        "displayValue": "View Content",
        "value": "ViewContent"
      },
      {
        "displayValue": "Search",
        "value": "Search"
      },
      {
        "displayValue": "Add to Cart",
        "value": "AddToCart"
      },
      {
        "displayValue": "Add To Wishlist",
        "value": "AddToWishlist"
      },
      {
        "displayValue": "Purchase",
        "value": "Purchase"
      },
      {
        "displayValue": "Lead",
        "value": "Lead"
      },
      {
        "displayValue": "Sign Up",
        "value": "SignUp"
      },
      {
        "value": "Custom",
        "displayValue": "Custom"
      }
    ],
    "displayName": "Event to Fire",
    "simpleValueType": true,
    "name": "eventType",
    "type": "SELECT"
  },
  {
    "type": "TEXT",
    "name": "customEventName",
    "displayName": "CustomEventName",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "eventType",
        "paramValue": "Custom",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "currency",
    "displayName": "Currency",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "eventType",
        "paramValue": "AddToCart",
        "type": "EQUALS"
      },
      {
        "paramName": "eventType",
        "paramValue": "AddToWishlist",
        "type": "EQUALS"
      },
      {
        "paramName": "eventType",
        "paramValue": "Purchase",
        "type": "EQUALS"
      },
      {
        "paramName": "eventType",
        "paramValue": "SignUp",
        "type": "EQUALS"
      },
      {
        "paramName": "eventType",
        "paramValue": "Lead",
        "type": "EQUALS"
      },
      {
        "paramName": "eventType",
        "paramValue": "Custom",
        "type": "EQUALS"
      }
    ],
    "help": "Currency should follow the ISO 4217 standard"
  },
  {
    "type": "TEXT",
    "name": "transactionValue",
    "displayName": "Transaction Value",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "eventType",
        "paramValue": "AddToCart",
        "type": "EQUALS"
      },
      {
        "paramName": "eventType",
        "paramValue": "AddToWishlist",
        "type": "EQUALS"
      },
      {
        "paramName": "eventType",
        "paramValue": "Purchase",
        "type": "EQUALS"
      },
      {
        "paramName": "eventType",
        "paramValue": "SignUp",
        "type": "EQUALS"
      },
      {
        "paramName": "eventType",
        "paramValue": "Lead",
        "type": "EQUALS"
      },
      {
        "paramName": "eventType",
        "paramValue": "Custom",
        "type": "EQUALS"
      }
    ],
    "help": "The value of the transaction as a decimal value of currency.  For example, a value of $10.99 USD should be entered as \"10.99\"."
  },
  {
    "type": "TEXT",
    "name": "itemCount",
    "displayName": "Item Count",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "eventType",
        "paramValue": "AddToCart",
        "type": "EQUALS"
      },
      {
        "paramName": "eventType",
        "paramValue": "AddToWishlist",
        "type": "EQUALS"
      },
      {
        "paramName": "eventType",
        "paramValue": "Purchase",
        "type": "EQUALS"
      },
      {
        "paramName": "eventType",
        "paramValue": "Custom",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "transactionId",
    "displayName": "Transaction ID",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "eventType",
        "paramValue": "Purchase",
        "type": "EQUALS"
      },
      {
        "paramName": "eventType",
        "paramValue": "SignUp",
        "type": "EQUALS"
      },
      {
        "paramName": "eventType",
        "paramValue": "Lead",
        "type": "EQUALS"
      },
      {
        "paramName": "eventType",
        "paramValue": "Custom",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "conversionId",
    "displayName": "Conversion ID",
    "simpleValueType": true,
    "help": "Unique Conversion ID that corresponds to a distinct conversion event. Conversion ID is used for deduplication and prevents the same conversion event from being processed more than once if it is sent multiple times."
  },
  {
    "type": "CHECKBOX",
    "name": "enableFirstPartyCookies",
    "checkboxText": "Enable First Party Cookies",
    "simpleValueType": true,
    "defaultValue": true
  },
  {
    "type": "CHECKBOX",
    "name": "advancedMatching",
    "checkboxText": "Enable Advanced Matching",
    "simpleValueType": true
  },
  {
    "type": "GROUP",
    "name": "advancedMatchingGroup",
    "displayName": "Advanced Matching Parameters",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "advancedMatchingParams",
        "displayName": "",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Parameter Name",
            "name": "name",
            "type": "SELECT",
            "selectItems": [
              {
                "value": "email",
                "displayValue": "Email"
              },
              {
                "value": "phoneNumber",
                "displayValue": "Phone Number"
              },
              {
                "value": "aaid",
                "displayValue": "AAID"
              },
              {
                "value": "idfa",
                "displayValue": "IDFA"
              },
              {
                "value": "externalId",
                "displayValue": "External ID"
              }
            ],
            "isUnique": true,
            "macrosInSelect": false
          },
          {
            "defaultValue": "",
            "displayName": "Parameter Value",
            "name": "value",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "advancedMatching",
        "paramValue": true,
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "dataProcessingOptions",
    "checkboxText": "Add Data Processing Options",
    "simpleValueType": true
  },
  {
    "type": "GROUP",
    "name": "dataProcessingOptionsGroup",
    "displayName": "Data Processing Parameters",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "dataProcessingParams",
        "displayName": "",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Parameter Name",
            "name": "name",
            "type": "SELECT",
            "selectItems": [
              {
                "value": "mode",
                "displayValue": "Mode"
              },
              {
                "value": "country",
                "displayValue": "Country"
              },
              {
                "value": "region",
                "displayValue": "Region"
              }
            ],
            "isUnique": true,
            "macrosInSelect": false
          },
          {
            "defaultValue": "",
            "displayName": "Parameter Value",
            "name": "value",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "dataProcessingOptions",
        "paramValue": true,
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "products",
    "displayName": "Product Information",
    "subParams": [
      {
        "type": "RADIO",
        "name": "productInputType",
        "displayName": "Input Type",
        "radioItems": [
          {
            "value": "entryManual",
            "displayValue": "Individual Entry",
            "help": "Configure product-level information using one row per unique product."
          },
          {
            "value": "entryJSON",
            "displayValue": "JSON Payload",
            "help": "Configure product-level information by submitting an array of unique products in JSON format."
          }
        ],
        "simpleValueType": true
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "productsRows",
        "displayName": "Individual Entry",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Product ID",
            "name": "id",
            "type": "TEXT",
            "valueHint": "The item\u0027s ID in the catalog",
            "isUnique": false
          },
          {
            "defaultValue": "",
            "displayName": "Product Name",
            "name": "name",
            "type": "TEXT",
            "valueHint": ""
          },
          {
            "defaultValue": "",
            "displayName": "Product Category",
            "name": "category",
            "type": "TEXT",
            "valueHint": "For example, Google\u0027s product taxonomy",
            "isUnique": false
          }
        ],
        "help": "The Product ID and Product Category are required, but the Product Name is optional.",
        "enablingConditions": [
          {
            "paramName": "productInputType",
            "paramValue": "entryManual",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "productsJSON",
        "displayName": "JSON Payload",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "productInputType",
            "paramValue": "entryJSON",
            "type": "EQUALS"
          }
        ],
        "help": "The Product ID and Product Category are required, but the Product Name is optional. Format: [ { \"id\": \"Product_ID\", \"name\": \"Product_Name\",  \"category\": \"Product_Category\" }, ... ]"
      }
    ],
    "groupStyle": "ZIPPY_CLOSED"
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

var injectScript = require('injectScript');
var copyFromWindow = require('copyFromWindow');
var setInWindow = require('setInWindow');
var callInWindow = require('callInWindow');
var createQueue = require('createQueue');
var makeTableMap = require('makeTableMap');
var makeNumber = require('makeNumber');
var JSON = require('JSON');
var copyFromDataLayer = require("copyFromDataLayer");

var getRdt = function() {
  var _rdt = copyFromWindow('rdt');
  if (_rdt) {
    return _rdt;
  }

  var queue;
  setInWindow('rdt', function () {
    var sendEvent = copyFromWindow('rdt.sendEvent');
    if (sendEvent) {
      callInWindow('rdt.sendEvent.apply', _rdt, arguments);
    } else {
      queue(arguments);
    }
  });
  queue = createQueue('rdt.callQueue');
  return copyFromWindow('rdt');
};

// Grabbing data from gtag() implementations
const eventModel = copyFromDataLayer("eventModel");
const ecommerce = copyFromDataLayer("ecommerce");
const userData = copyFromDataLayer("user_data");

// Attempt to get advanced matching parameters from data
var advancedMatchingParams = data.advancedMatchingParams && data.advancedMatchingParams.length ? data.advancedMatchingParams : null;

// If am parameters not available in data, get from data layer
if (!advancedMatchingParams) {
  advancedMatchingParams = copyFromDataLayer("advancedMatchingParams") || (eventModel && eventModel.advancedMatchingParams);
}

var eventMetadata = advancedMatchingParams && advancedMatchingParams.length ? makeTableMap(advancedMatchingParams, 'name', 'value') : {};
// copy advanced matching parameters
var initData = JSON.parse(JSON.stringify(eventMetadata));

if (userData) {
  if (!eventMetadata.email && (userData.sha256_email_address || userData.email_address)) {
    eventMetadata.email =
      userData.sha256_email_address || userData.email_address;
  }
  if (!eventMetadata.phoneNumber && (userData.sha256_phone_number || userData.phone_number)) {
    eventMetadata.phoneNumber =
      userData.sha256_phone_number || userData.phone_number;
  }
}

initData.integration = "gtm";

initData.partner = data.partner || copyFromDataLayer("partner") || '';

initData.useDecimalCurrencyValues = true;

var dataProcessingParams = data.dataProcessingParams && data.dataProcessingParams.length ? data.dataProcessingParams : null;

if (!dataProcessingParams) {
  dataProcessingParams = copyFromDataLayer("dataProcessingParams") || (eventModel && eventModel.dataProcessingParams);
}

var dataProcessingOptions = dataProcessingParams && dataProcessingParams.length ? makeTableMap(dataProcessingParams, 'name', 'value') : {};
if (dataProcessingOptions && dataProcessingOptions.mode) {
  initData.dpm = dataProcessingOptions.mode;
}
if (dataProcessingOptions.country) {
  initData.dpcc = dataProcessingOptions.country;
}
if (dataProcessingOptions.region) {
  initData.dprc = dataProcessingOptions.region;
}

var _rdt = getRdt();
if (!_rdt.pixelId) {
  _rdt('init', data.id, initData);
}

var enableFirstPartyCookies = data.enableFirstPartyCookies || copyFromDataLayer("enableFirstPartyCookies") || (eventModel && eventModel.enableFirstPartyCookies);
if (!enableFirstPartyCookies) {
  _rdt('disableFirstPartyCookies');
}

var isValidValue = function (val) {
  return val !== undefined && val !== null && val !== "";
};

eventMetadata.currency = data.currency || copyFromDataLayer("currency") || (eventModel && eventModel.currency) || (ecommerce && ecommerce.currency);

var value;
if (isValidValue(data.transactionValue)) {
  value = data.transactionValue;
} else if (isValidValue(copyFromDataLayer("transactionValue"))) {
  value = copyFromDataLayer("transactionValue");
} else if (eventModel && isValidValue(eventModel.transactionValue)) {
  value = eventModel.transactionValue;
} else if (ecommerce && isValidValue(ecommerce.value)) {
  value = ecommerce.value;
}
eventMetadata.value = value;

var formatCategories = function (item) {
  var categories = [];
  var categoryLevels = ["item_category", "item_category2", "item_category3", "item_category4", "item_category5"];
  
  for(var i = 0; i < categoryLevels.length; i++) {
    var key = categoryLevels[i];
    if(item[key]) {
      var value = item[key].trim();
      if (value !== "") {
        categories.push(value);
      }
    }
  }
  
  return categories.length > 0 ? categories.join(" > ") : null;
};

var processEcommerceItems = function () {
  var itemsToProcess =
    (ecommerce && ecommerce.items) || (eventModel && eventModel.items);

  // Process GA items ONLY if the array exists and is not empty
  if (itemsToProcess && itemsToProcess.length > 0) {
    var processedProducts = [];
    var processedItemCount = 0;
    for (var i = 0; i < itemsToProcess.length; i++) {
      var item = itemsToProcess[i];
      if (!item) continue;

      var product = {};

      if (item.item_id) product.id = item.item_id;
      if (item.item_name) product.name = item.item_name;

      var itemCategory = formatCategories(item);
      if (itemCategory) product.category = itemCategory;

      var quantity = 1;
      if (item.quantity !== undefined && item.quantity !== null) {
        var parsedQuantity = makeNumber(item.quantity);
        quantity = parsedQuantity;
      }

      processedItemCount += quantity;
      processedProducts.push(product);
    }
    if (processedProducts.length > 0) {
      return {
        products: processedProducts,
        itemCount: processedItemCount,
        foundItems: true,
      };
    }
  }
  // Return default if no items found, array was empty, or no valid products resulted
  return { products: [], itemCount: 0, foundItems: false };
};

var getProductData = function () {
  var itemCount =
    data.itemCount ||
    copyFromDataLayer("itemCount") ||
    (eventModel && eventModel.itemCount) ||
    null;

  if (
    data.productInputType == "entryManual" &&
    data.productsRows &&
    data.productsRows.length > 0
  ) {
    // The simple table is of the correct format - an array of objects.
    // We can assign it directly.
    return { products: data.productsRows, itemCount: itemCount };
  }
  if (
    data.productInputType == "entryJSON" &&
    data.productsJSON &&
    data.productsJSON.length > 0
  ) {
    return { products: data.productsJSON, itemCount: itemCount };
  }

  // Try grabbing product metadata from dataLayer
  const productRowsFromDataLayer =
    copyFromDataLayer("productsRows") ||
    (eventModel && eventModel.productsRows);
  const productJSONFromDataLayer =
    copyFromDataLayer("productsJSON") ||
    (eventModel && eventModel.productsJSON);

  if (productRowsFromDataLayer && productRowsFromDataLayer.length > 0) {
    return { products: productRowsFromDataLayer, itemCount: itemCount };
  }
  if (productJSONFromDataLayer && productJSONFromDataLayer.length > 0) {
    return { products: productJSONFromDataLayer, itemCount: itemCount };
  }
  
  // If there is no product metadata in the top-level data layer, check for the ecommerce object
  var ecommerceResult = processEcommerceItems();
  if (ecommerceResult.foundItems) {
    return {
      products: ecommerceResult.products,
      itemCount: ecommerceResult.itemCount,
    };
  }

  return { products: null, itemCount: itemCount};
};

var productInfo = getProductData();
var products = productInfo.products;
var itemCount = productInfo.itemCount;

if (products !== null) {
  eventMetadata.products = products;
}

var resolvedItemCount;
if (itemCount !== null) {
  var parsedItemCount = makeNumber(itemCount);
  if(data.eventType != "SignUp" && data.eventType != "Lead") {
    resolvedItemCount = parsedItemCount;
  }
}

eventMetadata.itemCount = resolvedItemCount;

// Certain events don't support certain params, so we conditionally set them
if (data.eventType != "AddToCart" && data.eventType != "AddToWishlist") {
  eventMetadata.transactionId =
    data.transactionId ||
    copyFromDataLayer("transactionId") ||
    (eventModel && eventModel.transactionId);
}

if (data.eventType == "Custom") {
  if (data.customEventName) {
    eventMetadata.customEventName = data.customEventName;
  } else {
    eventMetadata.customEventName = copyFromDataLayer("customEventName") || (eventModel && eventModel.customEventName);
  }
}

if (data.conversionId) {
  eventMetadata.conversionId = data.conversionId;
} else {
  eventMetadata.conversionId = copyFromDataLayer("conversionId") || (eventModel && eventModel.conversionId);
}

_rdt('track', data.eventType, eventMetadata);

injectScript('https://www.redditstatic.com/ads/pixel.js', data.gtmOnSuccess, data.gtmOnFailure, 'rdtPixel');


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://www.redditstatic.com/ads/pixel.js"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "rdt"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "rdt.callQueue"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "rdt.sendEvent.apply"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "rdt.callQueue.push"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "rdt.sendEvent"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "rdt.pixelId"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedKeys",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Test injectScript
  code: |-
    var success, failure;
    mock('injectScript', (url, onSuccess, onFailure) => {
      success = onSuccess;
      failure = onFailure;
      assertThat(url).isEqualTo('https://www.redditstatic.com/ads/pixel.js');
      onSuccess();
    });


    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('injectScript').wasCalledWith(url, success, failure, 'rdtPixel');
    assertApi('gtmOnSuccess').wasCalled();
- name: Test rdt exists
  code: |
    mock('copyFromWindow', key => {
      if (key === 'rdt') return () => {};
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Test rdt doesn't exist
  code: |-
    let rdt;

    mock('copyFromWindow', key => {
      if (key === 'rdt') return rdt;
    });

    mock('createQueue', function(name) {
      assertThat(name).isEqualTo('rdt.callQueue');
      return function(item) {
        assertThat(item).isNotNull();
      };
    });

    mock('setInWindow', (key, val) => {
      if (key === 'rdt') rdt = val;
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('setInWindow').wasCalled();
    assertApi('gtmOnSuccess').wasCalled();
- name: Test enabledFirstPartyCookies false
  code: |-
    mockData.enableFirstPartyCookies = false;

    let isSet = false;

    mock('copyFromWindow', key => {
      if (key === 'rdt') return function() {
         if (arguments[0] === 'disableFirstPartyCookies') {
           isSet = true;
         }
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertThat(isSet, 'disableFirstPartyCookies not set even though first party cookies are disabled').isTrue();
    assertApi('gtmOnSuccess').wasCalled();
- name: Test enabledFirstPartyCookies true
  code: |-
    mockData.enableFirstPartyCookies = true;

    mock('copyFromWindow', key => {
      if (key === 'rdt') return function() {
         if (arguments[0] === 'disableFirstPartyCookies') fail('disableFirstPartyCookies called even though first party cookies are enabled');
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Test Advanced Matching
  code: |
    mockData = {
      id: "t2_123",
      event_type: "PageVisit",
      enableFirstPartyCookies: true,
      advancedMatching: true,
      advancedMatchingParams: [
        {name: 'email', value: 'alice@example.com'},
        {name: 'phoneNumber', value: '222-333-4444'},
        {name: 'aaid', value: 'cdda802e-fb9c-47ad-9866-0794d394c912'},
        {name: 'idfa', value: 'EA7583CD-A667-48BC-B806-42ECB2B48606'}
      ],
    };

    const expected = {
      useDecimalCurrencyValues: true,
      email: 'alice@example.com',
      phoneNumber: '222-333-4444',
      aaid: 'cdda802e-fb9c-47ad-9866-0794d394c912',
      idfa: 'EA7583CD-A667-48BC-B806-42ECB2B48606',
      integration: 'gtm',
      partner: '',
    };

    mock('copyFromWindow', key => {
      if (key === 'rdt') return function() {
         if (arguments[0] === 'init') {
          assertThat(arguments[2], 'Advanced matching parameters incorrect').isEqualTo(expected);
        }
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('makeTableMap').wasCalledWith(mockData.advancedMatchingParams, 'name', 'value');
    assertApi('gtmOnSuccess').wasCalled();
- name: Test Event Metadata Purchase
  code: |-
    mockData = {
      id: "t2_potato",
      eventType: "Purchase",
      enableFirstPartyCookies: true,
      itemCount: 1,
      transactionValue: 1000,
      currency: "USD",
      transactionId: "123456789",
    };

    const expected = {
      conversionId: undefined,
      itemCount: 1,
      value: 1000,
      currency: 'USD',
      transactionId: '123456789'
    };

    mock('copyFromWindow', key => {
      if (key === 'rdt') return function() {
        if (arguments[0] === 'track') {
          assertThat(arguments[2], 'Event metadata parameters incorrect').isEqualTo(expected);
        }
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Test Event Metadata TransactionId Omission
  code: |-
    mockData = {
      id: "t2_potato",
      eventType: "AddToCart",
      enableFirstPartyCookies: true,
      itemCount: 1,
      transactionValue: 1000,
      currency: "USD",
      transactionId: "123456789",
    };

    const expected = {
      itemCount: 1,
      value: 1000,
      currency: 'USD',
      conversionId: undefined,
    };

    mock('copyFromWindow', key => {
      if (key === 'rdt') return function() {
        if (arguments[0] === 'track') {
          assertThat(arguments[2], 'Event metadata parameters incorrect').isEqualTo(expected);
        }
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Test Event Metadata ItemCount Omission
  code: |-
    mockData = {
      id: "t2_potato",
      eventType: "AddToCart",
      enableFirstPartyCookies: true,
      itemCount: 1,
      transactionValue: 1000,
      currency: "USD",
      transactionId: "123456789",
    };

    const expected = {
      itemCount: 1,
      value: 1000,
      currency: 'USD',
      conversionId: undefined,

    };

    mock('copyFromWindow', key => {
      if (key === 'rdt') return function() {
        if (arguments[0] === 'track') {
          assertThat(arguments[2], 'Event metadata parameters incorrect').isEqualTo(expected);
        }
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Test pixel init - set Pixel ID and integration type
  code: |-
    mock('copyFromWindow', key => {
      if (key === 'rdt') return function() {
        if (arguments[0] === 'init') {
          assertThat(arguments[1], 'Incorrect Pixel ID').isEqualTo(mockData.id);
          assertThat(arguments[2].integration, 'Integration type not set').isEqualTo('gtm');
        }
      };
    });
    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Test pixel init - set a2_ pixel ID and integration type
  code: |-
    mockData = {
      id: 'a2_123',
      eventType: 'PageVisit',
      enableFirstPartyCookies: true,
      advancedMatching: false,
      advancedMatchingParams: [],
    };

    mock('copyFromWindow', key => {
      if (key === 'rdt') return function() {
        if (arguments[0] === 'init') {
          assertThat(arguments[1], 'Incorrect Pixel ID').isEqualTo(mockData.id);
          assertThat(arguments[2].integration, 'Integration type not set').isEqualTo('gtm');
        }
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Test Tracking Event Type
  code: |-
    mock('copyFromWindow', key => {
      if (key === 'rdt') return function() {
        if (arguments[0] === 'track') {
          assertThat(arguments[1], 'Incorrect Tracking Event Type').isEqualTo(mockData.eventType);
        }
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Test Custom Event
  code: |-
    mockData = {
      id: "t2_potato",
      eventType: "Custom",
      enableFirstPartyCookies: true,
      itemCount: 1,
      transactionValue: 1000,
      currency: "USD",
      transactionId: "123456789",
      customEventName: "Subscribe",
    };

    const expected = {
      itemCount: 1,
      value: 1000,
      currency: 'USD',
      transactionId: "123456789",
      customEventName: "Subscribe",
      conversionId: undefined,
    };

    mock('copyFromWindow', key => {
      if (key === 'rdt') return function() {
        if (arguments[0] === 'track') {
          assertThat(arguments[2], 'Event metadata parameters incorrect').isEqualTo(expected);
        }
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Test Custom Event Name Omission
  code: |-
    mockData = {
      id: "t2_potato",
      eventType: "AddToCart",
      enableFirstPartyCookies: true,
      itemCount: 1,
      transactionValue: 1000,
      currency: "USD",
      transactionId: "123456789",
      customEventName: "Subscribe",
    };

    const expected = {
      itemCount: 1,
      value: 1000,
      currency: 'USD',
      conversionId: undefined,
    };

    mock('copyFromWindow', key => {
      if (key === 'rdt') return function() {
        if (arguments[0] === 'track') {
          assertThat(arguments[2], 'Event metadata parameters incorrect').isEqualTo(expected);
        }
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Test Products Rows
  code: |-
    mockData = {
      id: "t2_potato",
      eventType: "AddToCart",
      enableFirstPartyCookies: true,
      productInputType: "entryManual",
      productsRows: [{'id':'123456789','category':'Food','name':'Carne Asada Burrito'}]
    };

    const expected = {
      currency: undefined,
      value: undefined,
      itemCount: undefined,
      conversionId: undefined,
      products: [{'id':'123456789','category':'Food','name':'Carne Asada Burrito'}]
    };

    mock('copyFromWindow', key => {
      if (key === 'rdt') return function() {
        if (arguments[0] === 'track') {
          assertThat(arguments[2], 'Event metadata product parameters incorrect').isEqualTo(expected);
        }
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Test Products Empty Rows
  code: |-
    mockData = {
      id: "t2_potato",
      eventType: "AddToCart",
      enableFirstPartyCookies: true,
      productInputType: "entryManual",
      productsRows: []
    };

    const expected = {
      currency: undefined,
      value: undefined,
      itemCount: undefined,
      conversionId: undefined,
    };

    mock('copyFromWindow', key => {
      if (key === 'rdt') return function() {
        if (arguments[0] === 'track') {
          assertThat(arguments[2], 'Event metadata product parameters incorrect').isEqualTo(expected);
        }
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Test Products Mismatched Inputs
  code: |-
    mockData = {
      id: "t2_potato",
      eventType: "AddToCart",
      enableFirstPartyCookies: true,
      productInputType: "entryJSON",
      productsRows: []
    };

    const expected = {
      currency: undefined,
      value: undefined,
      itemCount: undefined,
      conversionId: undefined,
    };

    mock('copyFromWindow', key => {
      if (key === 'rdt') return function() {
        if (arguments[0] === 'track') {
          assertThat(arguments[2], 'Event metadata product parameters incorrect').isEqualTo(expected);
        }
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Test Products JSON
  code: |-
    mockData = {
      id: "t2_potato",
      eventType: "AddToCart",
      enableFirstPartyCookies: true,
      productInputType: "entryJSON",
      productsJSON: '[{"id":"123456789","category":"Food","name":"Carne Asada Burrito"}]',
    };

    const expected = {
      currency: undefined,
      value: undefined,
      itemCount: undefined,
      conversionId: undefined,
      products: '[{"id":"123456789","category":"Food","name":"Carne Asada Burrito"}]'
    };

    mock('copyFromWindow', key => {
      if (key === 'rdt') return function() {
        if (arguments[0] === 'track') {
          assertThat(arguments[2], 'Event metadata product parameters incorrect').isEqualTo(expected);
        }
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Test Event Metadata ConversionId
  code: |-
    mockData = {
      id: "t2_potato",
      eventType: "PageVisit",
      conversionId: "conversion-id",
    };

    const expected = {
      itemCount: undefined,
      value: undefined,
      currency: undefined,
      transactionId: undefined,
      conversionId: "conversion-id",
    };

    mock('copyFromWindow', key => {
      if (key === 'rdt') return function() {
        if (arguments[0] === 'track') {
          assertThat(arguments[2], 'Event metadata parameters incorrect').isEqualTo(expected);
        }
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Test Data Processing Options
  code: |
    mockData = {
      id: "t2_123",
      event_type: "PageVisit",
      enableFirstPartyCookies: true,
      advancedMatching: true,
      advancedMatchingParams: [
        {name: 'email', value: 'alice@example.com'},
        {name: 'phoneNumber', value: '222-333-4444'},
        {name: 'aaid', value: 'cdda802e-fb9c-47ad-9866-0794d394c912'},
        {name: 'idfa', value: 'EA7583CD-A667-48BC-B806-42ECB2B48606'}
      ],
      dataProcessingParams: [
        {name: 'mode', value: 'LDU'},
        {name: 'country', value: 'US'},
        {name: 'region', value: 'US_CA'}
      ]
    };

    const expected = {
      useDecimalCurrencyValues: true,
      email: 'alice@example.com',
      phoneNumber: '222-333-4444',
      aaid: 'cdda802e-fb9c-47ad-9866-0794d394c912',
      idfa: 'EA7583CD-A667-48BC-B806-42ECB2B48606',
      integration: 'gtm',
      partner: '',
      dpm: 'LDU',
      dpcc: 'US',
      dprc: 'US_CA'
    };

    mock('copyFromWindow', key => {
      if (key === 'rdt') return function() {
         if (arguments[0] === 'init') {
          assertThat(arguments[2], 'Data Processing params incorrect').isEqualTo(expected);
        }
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('makeTableMap').wasCalledWith(mockData.advancedMatchingParams, 'name', 'value');
    assertApi('makeTableMap').wasCalledWith(mockData.dataProcessingParams, 'name', 'value');
    assertApi('gtmOnSuccess').wasCalled();

    mockData.dataProcessingParams = [
      {name: 'country', value: 'US'}
    ];
    const expectedWithoutDPM = {
      useDecimalCurrencyValues: true,
      email: 'alice@example.com',
      phoneNumber: '222-333-4444',
      aaid: 'cdda802e-fb9c-47ad-9866-0794d394c912',
      idfa: 'EA7583CD-A667-48BC-B806-42ECB2B48606',
      partner: '',
      integration: 'gtm',
      dpcc: 'US'
    };
    mock('copyFromWindow', key => {
      if (key === 'rdt') return function() {
         if (arguments[0] === 'init') {
          assertThat(arguments[2], 'Data Processing params are partially filled').isEqualTo(expectedWithoutDPM);
        }
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('makeTableMap').wasCalledWith(mockData.advancedMatchingParams, 'name', 'value');
    assertApi('gtmOnSuccess').wasCalled();
- name: Test Partner
  code: |
    mockData = {
      id: "t2_123",
      event_type: "PageVisit",
      enableFirstPartyCookies: true,
      advancedMatching: true,
      partner: 'automatic_gtm',
      advancedMatchingParams: [
        {name: 'email', value: 'alice@example.com'},
        {name: 'phoneNumber', value: '222-333-4444'},
        {name: 'aaid', value: 'cdda802e-fb9c-47ad-9866-0794d394c912'},
        {name: 'idfa', value: 'EA7583CD-A667-48BC-B806-42ECB2B48606'}
      ],
    };

    const expected = {
      useDecimalCurrencyValues: true,
      email: 'alice@example.com',
      phoneNumber: '222-333-4444',
      aaid: 'cdda802e-fb9c-47ad-9866-0794d394c912',
      idfa: 'EA7583CD-A667-48BC-B806-42ECB2B48606',
      integration: 'gtm',
      partner: 'automatic_gtm',
    };


    mock('copyFromWindow', key => {
      if (key === 'rdt') return function() {
         if (arguments[0] === 'init') {
          assertThat(arguments[2], 'Parnter parameter incorrect').isEqualTo(expected);
        }
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('makeTableMap').wasCalledWith(mockData.advancedMatchingParams, 'name', 'value');
    assertApi('gtmOnSuccess').wasCalled();
- name: Test Copying from eventModel for gtag()
  code: |
    mockData = {
      eventType: "Custom",
      eventModel: {
        id: "t2_potato",
        enableFirstPartyCookies: true,
        conversionId: "conversion-id",
        productsJSON: '[{"id":"123456789","category":"Food","name":"Carne Asada Burrito"}]',
        itemCount: 1,
        transactionValue: 1000,
        currency: "USD",
        transactionId: "123456789",
        customEventName: "Subscribe",
        advancedMatching: true,
        advancedMatchingParams: [
          {name: 'email', value: 'alice@example.com'},
          {name: 'phoneNumber', value: '222-333-4444'},
          {name: 'aaid', value: 'cdda802e-fb9c-47ad-9866-0794d394c912'},
          {name: 'idfa', value: 'EA7583CD-A667-48BC-B806-42ECB2B48606'}
        ],
        dataProcessingParams: [
          {name: 'mode', value: 'LDU'},
          {name: 'country', value: 'US'},
          {name: 'region', value: 'US_CA'}
        ]
      },
    };

    const expectedAdvancedMatchingData = {
      useDecimalCurrencyValues: true,
      email: 'alice@example.com',
      phoneNumber: '222-333-4444',
      aaid: 'cdda802e-fb9c-47ad-9866-0794d394c912',
      idfa: 'EA7583CD-A667-48BC-B806-42ECB2B48606',
      integration: 'gtm',
      partner: '',
      dpm: 'LDU',
      dpcc: 'US',
      dprc: 'US_CA'
    };

    const expectedMetadata = {
      conversionId: "conversion-id",
      value: 1000,
      currency: "USD",
      transactionId: "123456789",
      customEventName: "Subscribe",
      itemCount: 1,
      products: '[{"id":"123456789","category":"Food","name":"Carne Asada Burrito"}]'
    };

    mock('copyFromDataLayer', function(key) {
      return mockData[key];
    });

    mock('copyFromWindow', key => {
      if (key === 'rdt') return function() {
        if (arguments[0] === 'track') {
          assertThat(arguments[2], 'Copied event parameters incorrect').isEqualTo(expectedMetadata);
        }
      };
    });

    mock('copyFromWindow', key => {
      if (key === 'rdt') return function() {
         if (arguments[0] === 'init') {
          assertThat(arguments[2], 'Copied advanced matching parameters incorrect').isEqualTo(expectedAdvancedMatchingData);
        }
      };
    });


    // Call runCode to run the template's code
    runCode(mockData);

    // Verify that the tag finished successfully
    assertApi('gtmOnSuccess').wasCalled();
- name: Test Copying from dataLayer
  code: |
    mockData = {
      eventType: "Custom",
      id: "t2_potato",
      enableFirstPartyCookies: true,
      conversionId: "conversion-id",
      productsJSON: '[{"id":"123456789","category":"Food","name":"Carne Asada Burrito"}]',
      itemCount: 1,
      transactionValue: 1000,
      currency: "USD",
      transactionId: "123456789",
      customEventName: "Subscribe",
      advancedMatching: true,
      advancedMatchingParams: [
        {name: 'email', value: 'alice@example.com'},
        {name: 'phoneNumber', value: '222-333-4444'},
        {name: 'aaid', value: 'cdda802e-fb9c-47ad-9866-0794d394c912'},
        {name: 'idfa', value: 'EA7583CD-A667-48BC-B806-42ECB2B48606'}
      ],
      dataProcessingParams: [
        {name: 'mode', value: 'LDU'},
        {name: 'country', value: 'US'},
        {name: 'region', value: 'US_CA'}
      ]
    };

    const expectedAdvancedMatchingData = {
      useDecimalCurrencyValues: true,
      email: 'alice@example.com',
      phoneNumber: '222-333-4444',
      aaid: 'cdda802e-fb9c-47ad-9866-0794d394c912',
      idfa: 'EA7583CD-A667-48BC-B806-42ECB2B48606',
      integration: 'gtm',
      partner: '',
      dpm: 'LDU',
      dpcc: 'US',
      dprc: 'US_CA'
    };

    const expectedMetadata = {
      conversionId: "conversion-id",
      value: 1000,
      currency: "USD",
      transactionId: "123456789",
      customEventName: "Subscribe",
      itemCount: 1,
      products: '[{"id":"123456789","category":"Food","name":"Carne Asada Burrito"}]'
    };

    mock('copyFromDataLayer', function(key) {
      return mockData[key];
    });

    mock('copyFromWindow', key => {
      if (key === 'rdt') return function() {
        if (arguments[0] === 'track') {
          assertThat(arguments[2], 'Copied event parameters incorrect').isEqualTo(expectedMetadata);
        }
      };
    });

    mock('copyFromWindow', key => {
      if (key === 'rdt') return function() {
         if (arguments[0] === 'init') {
          assertThat(arguments[2], 'Copied advanced matching parameters incorrect').isEqualTo(expectedAdvancedMatchingData);
        }
      };
    });


    // Call runCode to run the template's code
    runCode(mockData);

    // Verify that the tag finished successfully
    assertApi('gtmOnSuccess').wasCalled();
- name: Test user_data mapping from dataLayer
  code: |-
    // Simulate user_data in data layer
    mock("copyFromDataLayer", (key) => {
      if (key === "user_data") {
        return {
          email_address: "user@example.com",
          phone_number: "555-123-4567",
        };
      }
      return undefined;
    });

    let initArgs = null;
    let trackArgs = null;

    // Intercept rdt calls
    mock("copyFromWindow", (key) => {
      if (key === "rdt")
        return function () {
          if (arguments[0] === "init") {
            initArgs = arguments;
          }
          if (arguments[0] === "track") {
            trackArgs = arguments;
          }
        };
    });

    // Run the template code
    runCode(mockData);

    // Assert track call also received user_data via metadata merge
    assertThat(trackArgs).isNotNull();
    assertThat(trackArgs[2].email).isEqualTo("user@example.com");
    assertThat(trackArgs[2].phoneNumber).isEqualTo("555-123-4567");

    // Verify success
    assertApi("gtmOnSuccess").wasCalled();
- name: Test user_data mapping - explicit advancedMatchingParams Priority
  code: |
    // Provide explicit params via mockData (simulates UI config)
    mockData.advancedMatchingParams = [
      { name: "email", value: "userEmailFromAMParams@example.com" },
    ];

    // Simulate user_data in data layer with DIFFERENT email
    mock("copyFromDataLayer", (key) => {
      if (key === "user_data") {
        return {
          email_address: "userEmailFromDL@example.com", // This should be ignored
          phone_number: "555-111-2222", // This should be used as it's not in explicit config
        };
      }
      if (key === "advancedMatchingParams") {
        // Ensure DL 'advancedMatchingParams' is not used
        return undefined;
      }
      return undefined;
    });

    let initArgs = null;
    let trackArgs = null;

    // Intercept rdt calls
    mock("copyFromWindow", (key) => {
      if (key === "rdt")
        return function () {
          if (arguments[0] === "init") {
            initArgs = arguments;
          }
          if (arguments[0] === "track") {
            trackArgs = arguments;
          }
        };
    });

    // Run the template code
    runCode(mockData);

    // Assert track also uses email from AM Params if provided and GA phone
    assertThat(trackArgs).isNotNull();
    assertThat(trackArgs[2].email).isEqualTo("userEmailFromAMParams@example.com");
    assertThat(trackArgs[2].phoneNumber).isEqualTo("555-111-2222"); // From user_data

    // Verify success
    assertApi("gtmOnSuccess").wasCalled();
- name: Test ecommerce mapping
  code: |
    // Simulate ecommerce object in data layer
    mock("copyFromDataLayer", (key) => {
      if (key === "ecommerce") {
        return {
          currency: "USD",
          value: 55.99,
          items: [
            { item_id: "SKU1", item_name: "Product A", quantity: 1 },
            { item_id: "SKU2", item_name: "Product B", quantity: 2 },
            { item_id: "SKU3", item_name: "Product C" }, // quantity not provided
          ],
        };
      }
      return undefined;
    });

    let trackArgs = null;

    // Intercept rdt track call
    mock("copyFromWindow", (key) => {
      if (key === "rdt")
        return function () {
          if (arguments[0] === "track") {
            trackArgs = arguments;
          }
        };
    });

    runCode(mockData);

    // Assert track call metadata
    assertThat(trackArgs).isNotNull();
    const metadata = trackArgs[2];
    assertThat(metadata.currency).isEqualTo("USD");
    assertThat(metadata.value).isEqualTo(55.99);
    assertThat(metadata.itemCount).isEqualTo(4); // 2 + 1 + 1 (SKU3 - if quantity not provided, we set to 1
    assertThat(metadata.products).isEqualTo([
      { id: "SKU1", name: "Product A" },
      { id: "SKU2", name: "Product B" },
      { id: "SKU3", name: "Product C" },
    ]);

    // Verify success
    assertApi("gtmOnSuccess").wasCalled();
- name: Test ecommerce mapping - Category Formatting
  code: |
    // Simulate ecommerce with hierarchical categories
    mock("copyFromDataLayer", (key) => {
      if (key === "ecommerce") {
        return {
          items: [
            {
              item_id: "SKU_CAT",
              item_name: "Cat Product",
              quantity: 1,
              item_category: "Apparel",
              item_category2: " Mens ",
              item_category3: "Shirts",
              item_category4: "",
              item_category5: "  ",
            },
            { item_id: "SKU_NOCAT", item_name: "No Cat Product", quantity: 1 },
          ],
        };
      }
      return undefined;
    });

    let trackArgs = null;

    // Intercept rdt track call
    mock("copyFromWindow", (key) => {
      if (key === "rdt")
        return function () {
          if (arguments[0] === "track") {
            trackArgs = arguments;
          }
        };
    });

    runCode(mockData);

    // Assert product categories
    assertThat(trackArgs).isNotNull();
    const products = trackArgs[2].products;
    assertThat(products).isNotNull();
    assertThat(products.length).isEqualTo(2);
    assertThat(products[0].category).isEqualTo("Apparel > Mens > Shirts");
    assertThat(products[1].category).isEqualTo(undefined);

    // Verify success
    assertApi("gtmOnSuccess").wasCalled();
- name: Test Priority Order
  code: |
    mockData = {
      id: "t2_reddit",
      eventType: "Purchase",
      productInputType: "entryManual",
      productsRows: [{ id: "UI_123", name: "UI Product" }],
      itemCount: 5,
      currency: "USD",
      transactionValue: 50,
    };

    // Mock both dataLayer products and GA ecommerce
    mock("copyFromDataLayer", function (key) {
      if (key === "productsRows")
        return [{ id: "DL_123", name: "DataLayer Product" }];
      if (key === "ecommerce")
        return {
          currency: "EUR",
          value: 150,
          items: [
            {
              item_id: "GA_123",
              item_name: "GA Product",
              quantity: 3,
            },
          ],
        };
      return undefined;
    });

    // Verify UI products are selected over others
    mock("copyFromWindow", (key) => {
      if (key === "rdt")
        return function () {
          if (arguments[0] === "track") {
            const metadata = arguments[2];
            assertThat(metadata.products[0].id).isEqualTo("UI_123");
            assertThat(metadata.currency).isEqualTo("USD");
            assertThat(metadata.value).isEqualTo(50);
            assertThat(metadata.itemCount).isEqualTo(5);
          }
        };
    });

    runCode(mockData);
    assertApi("gtmOnSuccess").wasCalled();
- name: Test Priority Order - Multiple Data Sources for Same Fields
  code: |
    mockData = {
      id: "t2_reddit",
      eventType: "Purchase",
      currency: "USD", // UI currency
      transactionValue: 100, // UI value
      productInputType: "entryManual",
      productsRows: [{ id: "UI_ID", name: "UI Product" }], // UI products
      itemCount: 1, // UI item count
    };

    // Set up DataLayer
    mock("copyFromDataLayer", function (key) {
      if (key === "currency") return "EUR";
      if (key === "transactionValue") return 200;
      if (key === "productsRows") return [{ id: "DL_ID", name: "DL Product" }];
      if (key === "itemCount") return 2;
      if (key === "ecommerce") // Different fields from ecommerce object
        return {
          currency: "JPY",
          value: 300,
          items: [
            {
              item_id: "GA_ID",
              item_name: "GA Product",
              quantity: 3,
            },
          ],
        };
      return undefined;
    });

    // Intercept track call to verify highest priority values are used
    mock("copyFromWindow", (key) => {
      if (key === "rdt")
        return function () {
          if (arguments[0] === "track") {
            const metadata = arguments[2];

            // UI values should win over DataLayer and GA ecommerce values
            assertThat(
              metadata.currency,
              "UI currency should have priority"
            ).isEqualTo("USD");
            assertThat(metadata.value, "UI value should have priority").isEqualTo(
              100
            );
            assertThat(
              metadata.products[0].id,
              "UI products should have priority"
            ).isEqualTo("UI_ID");
            assertThat(
              metadata.itemCount,
              "UI item count should have priority"
            ).isEqualTo(1);
          }
        };
    });

    runCode(mockData);
    assertApi("gtmOnSuccess").wasCalled();
- name: Test Priority Order - DataLayer over GA when UI Missing
  code: "mockData = {\n  id: \"t2_reddit\",\n  eventType: \"Purchase\",\n};\n\n//\
    \ Set up DataLayer and GA ecommerce \nmock(\"copyFromDataLayer\", function (key)\
    \ {\n  if (key === \"currency\") return \"EUR\";\n  if (key === \"transactionValue\"\
    ) return 200; \n  if (key === \"productsRows\") return [{ id: \"DL_ID\", name:\
    \ \"DL Product\" }];\n  if (key === \"itemCount\") return 2;\n  if (key === \"\
    ecommerce\")\n    return {\n      currency: \"JPY\",\n      value: 300,\n    \
    \  items: [\n        {\n          item_id: \"ecommerce_ID\",\n          item_name:\
    \ \"ecommerce Product\",\n          quantity: 3,\n        },\n      ],\n    };\n\
    \  return undefined;\n});\n\n// Intercept track call to verify DataLayer values\
    \ used when UI is missing\nmock(\"copyFromWindow\", (key) => {\n  if (key ===\
    \ \"rdt\")\n    return function () {\n      if (arguments[0] === \"track\") {\n\
    \        const metadata = arguments[2];\n\n        // DataLayer values should\
    \ win over ecommerce values\n        assertThat(\n          metadata.currency,\n\
    \          \"DataLayer currency should have priority over ecommerce\"\n      \
    \  ).isEqualTo(\"EUR\");\n        assertThat(\n          metadata.value,\n   \
    \       \"DataLayer value should have priority over ecommerce\"\n        ).isEqualTo(200);\n\
    \        assertThat(\n          metadata.products[0].id,\n          \"DataLayer\
    \ products should have priority over ecommerce\"\n        ).isEqualTo(\"DL_ID\"\
    );\n        assertThat(\n          metadata.itemCount,\n          \"DataLayer\
    \ item count should have priority over ecommerce\"\n        ).isEqualTo(2);\n\
    \      }\n    };\n});\n\nrunCode(mockData);\nassertApi(\"gtmOnSuccess\").wasCalled();\n"
- name: Test Zero Value Handling
  code: |
    mockData = {
      id: "t2_reddit",
      eventType: "Purchase",
      transactionValue: 0, // Explicitly set to zero in UI
      currency: "USD",
    };

    // Set up non-zero values in data layer and ecommerce
    mock("copyFromDataLayer", function (key) {
      if (key === "transactionValue") return 100; // DL value should be ignored
      if (key === "ecommerce")
        return {
          value: 200, // GA value should be ignored
          currency: "EUR",
        };
      return undefined;
    });

    // Intercept track call to verify zero value is preserved
    mock("copyFromWindow", (key) => {
      if (key === "rdt")
        return function () {
          if (arguments[0] === "track") {
            // Verify that the zero value from UI is used, not the fallbacks
            assertThat(
              arguments[2].value,
              "Zero value should be preserved"
            ).isEqualTo(0);
            assertThat(arguments[2].currency).isEqualTo("USD");
          }
        };
    });

    runCode(mockData);
    assertApi("gtmOnSuccess").wasCalled();
setup: |-
  let mockData = {
    id: 't2_123',
    eventType: 'PageVisit',
    enableFirstPartyCookies: true,
    advancedMatching: false,
    advancedMatchingParams: [],
  };

  const url = 'https://www.redditstatic.com/ads/pixel.js';

  mock('injectScript', (url, onSuccess, onFailure) => {
    onSuccess();
  });


___NOTES___

Created on 1/13/2020, 9:31:41 AM


